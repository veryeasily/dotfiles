" vim: ft=vim

if empty(glob($HOME."/.vim/autoload/plug.vim"))
  if system('command -v curl || echo "Curl required to auto-install vim-plug.."')
    !mkdir ~/.vim/autoload >/dev/null 2>&1
    !curl -o $HOME/.vim/autoload/plug.vim -L -C -
       \ https://raw.githubusercontent.com/junegunn/vim-plug/master/plug.vim
  endif
endif

set background=dark

let far#source = 'rg'
let g:NERDTreeWinPos = 'right'
let g:NERDTreeWinSize = 20
let g:ackprg = 'rg --vimgrep --hidden'
"let g:ale_enabled = 1
"let g:ale_lint_delay = 2000
"let g:ale_lint_on_enter = 0 " Less distracting when opening a new file
"let g:ale_set_quickfix = 1
"let g:ale_pattern_options = {
"\   'activist': {
"\     'ale_linters': ['eslint', 'flow'],
"\     'ale_fixers': ['prettier']
"\   }
"\ }
let g:bookmark_highlight_lines = 1
let g:bookmark_sign = 'â™¥'
"let g:completor_blacklist = ['tagbar', 'qf', 'netrw', 'unite', 'vimwiki', 'nerdtree']
"let g:completor_php_omni_trigger = '\$?\w+|\$?\w+\s+=\s+\w+'
let g:gutentags_cache_dir = $HOME.'/.vim/gutentags'
let g:gutentags_ctags_exclude = ['vendor', 'node_modules', 'log', 'tmp', 'public', 'dist', 'build']
let g:gutentags_ctags_options_file = $HOME.'/.ctags'
let g:gutentags_define_advanced_commands = 1
let g:gutentags_generate_on_empty_buffer = 1
let g:gutentags_project_root = ['Gemfile']
let g:jsx_ext_required = 0
let g:marvim_find_key = '<leader>M'
let g:marvim_find_key = '<leader>m'
let g:one_allow_italics = 1
let g:tagbar_width = 20
" let g:tern_map_keys=1
" let g:tern_map_prefix='<space>'
" let g:tern_request_timeout = 2
" let g:tern_show_argument_hints="on_move"
let g:tmux_navigator_no_mappings = 1
let g:user_emmet_install_global = 1
if executable('ripper-tags')
    let g:tagbar_type_ruby = {
        \ 'kinds'      : ['m:modules',
                        \ 'c:classes',
                        \ 'C:constants',
                        \ 'F:singleton methods',
                        \ 'f:methods',
                        \ 'a:aliases'],
        \ 'kind2scope' : { 'c' : 'class',
                        \ 'm' : 'class' },
        \ 'scope2kind' : { 'class' : 'c' },
        \ 'ctagsbin'   : 'ripper-tags',
        \ 'ctagsargs'  : ['-f', '-']
        \ }
else
    let g:tagbar_type_ruby = {
        \ 'kinds' : [
            \ 'm:modules',
            \ 'c:classes',
            \ 'd:describes',
            \ 'C:contexts',
            \ 'f:methods',
            \ 'F:singleton methods'
        \ ]
    \ }
endif
let g:zv_file_types = {
            \   'scss'  : 'sass',
            \   'sh'    : 'bash',
            \   'tex'   : 'latex',
            \   'yaml' : 'ansible',
            \   'yml' : 'ansible',
            \ }

exec 'silent! !mkdir -p' g:gutentags_cache_dir

call plug#begin('~/.vim/plugged')

" Plug 'ervandew/supertab'

Plug 'tpope/vim-scriptease'
Plug 'airblade/vim-rooter'
Plug 'mattn/webapi-vim' " Required by gist-vim
Plug 'mattn/gist-vim'
Plug 'editorconfig/editorconfig-vim'
Plug 'cakebaker/scss-syntax.vim'
Plug 'junegunn/fzf', { 'dir': $HOME . '/.fzf', 'do': 'yes \| ./install --all' }
Plug 'junegunn/fzf.vim'
Plug 'junegunn/vim-peekaboo'
Plug 'junegunn/vim-easy-align'
Plug 'sheerun/vim-polyglot'
Plug 'vito-c/jq.vim'
Plug 'veryeasily/vim-tmux-navigator' " We use my fork modified for i3
Plug 'Kuniwak/vint'
Plug 'moll/vim-node'
Plug 'othree/html5.vim'
Plug 'majutsushi/tagbar'
Plug 'scrooloose/nerdcommenter'
Plug 'scrooloose/nerdtree'
Plug 'SpaceVim/gtags.vim'
Plug 'ekalinin/Dockerfile.vim'
Plug 'mxw/vim-jsx'
Plug 'mattn/emmet-vim'
" Plug 'Chiel92/vim-autoformat'
Plug 'junegunn/vader.vim' " Test framework for vimscripts. See https://github.com/junegunn/vader.vim
Plug 'pearofducks/ansible-vim'

if v:version >= 800
  Plug 'SirVer/ultisnips'
  Plug 'honza/vim-snippets'

  if has('python3')
    Plug 'neoclide/coc.nvim', {'branch': 'release'}
  endif
endif

" neovim specific
if has('nvim')
  "Plug 'w0rp/ale'
  Plug 'roxma/nvim-completion-manager'
  Plug 'roxma/nvim-cm-tern',  {'do': 'npm install'}
  Plug 'roxma/ncm-flow'
  Plug 'roxma/ncm-github'
endif

Plug 'ludovicchabant/vim-gutentags'
Plug 'tpope/vim-bundler'
Plug 'tpope/vim-fugitive'
Plug 'shumphrey/fugitive-gitlab.vim'
Plug 'tpope/vim-haml'
Plug 'tpope/vim-obsession'
Plug 'tpope/vim-rails'
Plug 'tpope/vim-rails'
Plug 'tpope/vim-rake'
Plug 'tpope/vim-rbenv'
Plug 'tpope/vim-repeat'
Plug 'tpope/vim-speeddating'
Plug 'tpope/vim-surround'
Plug 'plasticboy/vim-markdown'
Plug 'easymotion/vim-easymotion'
Plug 'brooth/far.vim'
Plug 'KabbAmine/zeavim.vim'
Plug 'altercation/vim-colors-solarized'
Plug 'pangloss/vim-javascript'
Plug 'leafgarland/typescript-vim'
Plug 'flowtype/vim-flow'
Plug 'moll/vim-node'
Plug 'peitalin/vim-jsx-typescript'
Plug 'rakr/vim-one'
Plug 'morhetz/gruvbox'
Plug 'dbeniamine/cheat.sh-vim'
Plug 'epilande/vim-react-snippets'

call plug#end()

vmap <Enter> <Plug>(EasyAlign)
nmap ga <Plug>(EasyAlign)
nnoremap <silent> h :TmuxNavigateLeft<cr>
nnoremap <silent> j :TmuxNavigateDown<cr>
nnoremap <silent> k :TmuxNavigateUp<cr>
nnoremap <silent> l :TmuxNavigateRight<cr>
nnoremap <silent> \ :TmuxNavigatePrevious<cr>

map <leader>fd <Plug>(TsuquyomiSplitDefinition)

" Leave easy motion as the double leaderkey
map <Space> <Plug>(easymotion-prefix)
map <Space>W <Plug>(easymotion-bd-W)
map <Space>w <Plug>(easymotion-bd-w)
map gs <Plug>(easymotion-bd-t)
map s <Plug>(easymotion-s)

"augroup EMMET
  "au!
  "autocmd FileType html,css,javascript.jsx,typescript.tsx EmmetInstall
  "autocmd FileType html,css,eruby EmmetInstall
"augroup END

" " NERDTree config
" " see: https://github.com/scrooloose/nerdtree#faq
" augroup NERD
"   au!
"   autocmd VimEnter * NERDTreeVCS
"   autocmd VimEnter * wincmd p
"   autocmd bufenter * if (winnr("$") == 1 && exists("b:NERDTree") && b:NERDTree.isTabTree()) | q | endif
" augroup END

" augroup TAGBAR
"   au!
"   autocmd VimEnter * nested :call tagbar#autoopen(0)
" augroup END

if has('termguicolors')
  """
  " COLORS
  " set Vim-specific sequences for RGB colors
  " Borrowed from https://github.com/vim/vim/issues/993
  set termguicolors
  silent! let &t_8f = "\<Esc>[38;2;%lu;%lu;%lum"
  silent! let &t_8b = "\<Esc>[48;2;%lu;%lu;%lum"
endif

if has('gui_running')
  set guifont=Fira\ Code\ weight=450\ 12
endif

if &diff
  silent! colorscheme gruvbox
else
  silent! colorscheme one
  set background=dark
  " hi Normal guibg=NONE ctermbg=NONE
  " hi NonText guibg=NONE ctermbg=NONE
endif

" Vim named bookmarks
highlight BookmarkSign ctermbg=NONE ctermfg=160
highlight BookmarkLine ctermbg=194 ctermfg=NONE

" Defined in .vimrc.functions
call editorconfig#AddNewHook(function('LJU_filetype_hook'))

" COC STUFF

command! -nargs=0 Prettier :CocCommand prettier.formatFile

vmap <leader>f  <Plug>(coc-format-selected)
nmap <leader>f  <Plug>(coc-format-selected)

" if hidden is not set, TextEdit might fail.
set hidden

" Some servers have issues with backup files, see #649
set nobackup
set nowritebackup

" Better display for messages
set cmdheight=2

" You will have bad experience for diagnostic messages when it's default 4000.
set updatetime=300

" don't give |ins-completion-menu| messages.
set shortmess+=c

" always show signcolumns
set signcolumn=yes

" Use tab for trigger completion with characters ahead and navigate.
" Use command ':verbose imap <tab>' to make sure tab is not mapped by other plugin.
inoremap <silent><expr> <TAB>
      \ pumvisible() ? "\<C-n>" :
      \ <SID>check_back_space() ? "\<TAB>" :
      \ coc#refresh()
inoremap <expr><S-TAB> pumvisible() ? "\<C-p>" : "\<C-h>"

function! s:check_back_space() abort
  let col = col('.') - 1
  return !col || getline('.')[col - 1]  =~# '\s'
endfunction

" Use <c-space> to trigger completion.
inoremap <silent><expr> <c-space> coc#refresh()

" Use <cr> to confirm completion, `<C-g>u` means break undo chain at current position.
" Coc only does snippet and additional edit on confirm.
inoremap <expr> <cr> pumvisible() ? "\<C-y>" : "\<C-g>u\<CR>"

" Use `[g` and `]g` to navigate diagnostics
nmap <silent> [g <Plug>(coc-diagnostic-prev)
nmap <silent> ]g <Plug>(coc-diagnostic-next)

" Remap keys for gotos
nmap <silent> gd <Plug>(coc-definition)
nmap <silent> gy <Plug>(coc-type-definition)
nmap <silent> gi <Plug>(coc-implementation)
nmap <silent> gr <Plug>(coc-references)

" Use K to show documentation in preview window
nnoremap <silent> K :call <SID>show_documentation()<CR>

function! s:show_documentation()
  if (index(['vim','help'], &filetype) >= 0)
    execute 'h '.expand('<cword>')
  else
    call CocAction('doHover')
  endif
endfunction

" Highlight symbol under cursor on CursorHold
autocmd CursorHold * silent call CocActionAsync('highlight')

" Remap for rename current word
nmap <leader>rn <Plug>(coc-rename)

" Remap for format selected region
xmap <leader>f  <Plug>(coc-format-selected)
nmap <leader>f  <Plug>(coc-format-selected)

augroup mygroup
  autocmd!
  " Setup formatexpr specified filetype(s).
  autocmd FileType typescript,json setl formatexpr=CocAction('formatSelected')
  " Update signature help on jump placeholder
  autocmd User CocJumpPlaceholder call CocActionAsync('showSignatureHelp')
augroup end

" Remap for do codeAction of selected region, ex: `<leader>aap` for current paragraph
xmap <leader>a  <Plug>(coc-codeaction-selected)
nmap <leader>a  <Plug>(coc-codeaction-selected)

" Remap for do codeAction of current line
nmap <leader>ac  <Plug>(coc-codeaction)
" Fix autofix problem of current line
nmap <leader>qf  <Plug>(coc-fix-current)

" Create mappings for function text object, requires document symbols feature
" of languageserver.

xmap if <Plug>(coc-funcobj-i)
xmap af <Plug>(coc-funcobj-a)
omap if <Plug>(coc-funcobj-i)
omap af <Plug>(coc-funcobj-a)

" Use <tab> for select selections ranges, needs server support, like: coc-tsserver, coc-python
nmap <silent> <TAB> <Plug>(coc-range-select)
xmap <silent> <TAB> <Plug>(coc-range-select)
xmap <silent> <S-TAB> <Plug>(coc-range-select-backword)

" Use `:Format` to format current buffer
command! -nargs=0 Format :call CocAction('format')

" Use `:Fold` to fold current buffer
command! -nargs=? Fold :call     CocAction('fold', <f-args>)

" use `:OR` for organize import of current buffer
command! -nargs=0 OR   :call     CocAction('runCommand', 'editor.action.organizeImport')

" Add status line support, for integration with other plugin, checkout `:h coc-status`
set statusline^=%{coc#status()}%{get(b:,'coc_current_function','')}

" Using CocList
" Show all diagnostics
nnoremap <silent> <space>a  :<C-u>CocList diagnostics<cr>
" Manage extensions
nnoremap <silent> <space>e  :<C-u>CocList extensions<cr>
" Show commands
nnoremap <silent> <space>c  :<C-u>CocList commands<cr>
" Find symbol of current document
nnoremap <silent> <space>o  :<C-u>CocList outline<cr>
" Search workspace symbols
nnoremap <silent> <space>s  :<C-u>CocList -I symbols<cr>
" Do default action for next item.
nnoremap <silent> <space>j  :<C-u>CocNext<CR>
" Do default action for previous item.
nnoremap <silent> <space>k  :<C-u>CocPrev<CR>
" Resume latest coc list
nnoremap <silent> <space>p  :<C-u>CocListResume<CR>
" Reformat the current document
noremap <silent> F :<C-u>Format<CR>
